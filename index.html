<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quản Lý Thiết Bị Thông Minh</title>
    <link rel="icon" type="image/png" href="anh/iconhien.png">
    <style>
        body {
            font-family: Arial, sans-serif;
            background-image: url('https://images.unsplash.com/photo-1506748686214-e9df14d4d9d0?crop=entropy&cs=tinysrgb&fit=max&fm=jpg&ixid=MnwxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8&ixlib=rb-1.2.1&q=80&w=1080');
            background-size: cover;
            background-position: center;
            margin: 0;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: auto;
            padding: 20px;
            border-radius: 10px;
            background-color: rgba(255, 255, 255, 0.9);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
        }

        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 20px;
        }

        .section {
            margin-bottom: 40px;
            padding: 20px;
            border-radius: 10px;
            background-color: rgba(255, 255, 255, 0.8);
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.15);
        }

        .info-container, .device-container {
            display: flex;
            justify-content: space-around;
            flex-wrap: wrap;
        }

        .info-item, .device-item {
            display: flex;
            align-items: center;
            flex: 1;
            min-width: 150px;
            margin: 10px;
            text-align: center;
            padding: 10px;
            border-radius: 8px;
            background-color: #f8f8f8;
            box-shadow: 0 1px 5px rgba(0, 0, 0, 0.1);
            transition: transform 0.2s;
        }

            .info-item:hover, .device-item:hover {
                transform: scale(1.05);
            }

        .info-icon, .device-icon {
            width: 50px;
            height: 50px;
            margin-right: 10px;
        }

        .info-value, .device-status {
            font-size: 15px;
            font-weight: bold;
            color: #555;
        }

        .settings-button {
            margin-top: 10px;
            padding: 8px;
            background-color: transparent;
            border: none;
            cursor: pointer;
            transition: transform 0.3s;
        }

            .settings-button:hover {
                transform: scale(1.1);
            }

        .settings-icon {
            width: 40px;
            height: 40px;
        }

        .popup {
            display: none;
            position: fixed;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            justify-content: center;
            align-items: center;
        }

        .popup-content {
            background-color: #ffffff;
            padding: 20px;
            border-radius: 10px;
            width: 300px;
            text-align: center;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        }
        .confirmSettings {
            background-color: #4CAF50; /* Màu xanh */
            margin-top: 10px;
            padding: 8px 12px;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
            .confirmSettings:hover {
                background-color: #45a049; /* Màu xanh đậm khi hover */
            }

        .close-button {
            margin-top: 10px;
            padding: 8px 12px;
            background-color: #f44336;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }

            .close-button:hover {
                background-color: #d32f2f;
            }

        .input-field {
            margin: 10px 0;
        }

            .input-field input {
                padding: 8px;
                width: 80%;
                border: 1px solid #ccc;
                border-radius: 5px;
                transition: border-color 0.3s;
            }

                .input-field input:focus {
                    border-color: #4CAF50;
                    outline: none;
                }

        .mode-container {
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 20px 0;
        }

            .mode-container div {
                margin-right: 10px;
                font-size: 18px;
                font-weight: bold;
                color: #333;
            }

        .buttonCD {
            background-color: #FF0000; /* Màu nền */
            color: white; /* Màu chữ */
            padding: 8px 25px; /* Khoảng cách bên trong */
            border: none; /* Bỏ viền */
            border-radius: 5px; /* Bo góc */
            font-size: 15px; /* Kích thước chữ */
            cursor: pointer; /* Con trỏ chuột */
            transition: background-color 0.3s, transform 0.2s; /* Hiệu ứng chuyển màu và phóng to */
        }

            .buttonCD:hover {
                background-color: #EE0000; /* Màu nền khi hover */
                transform: scale(1.05); /* Phóng to nhẹ khi hover */
            }

            .buttonCD:active {
                transform: scale(0.95); /* Thu nhỏ khi nhấn */
            }
        .buttonDB {
            background-color: #008000; /* Màu nền */
            color: white; /* Màu chữ */
            padding: 8px 25px; /* Khoảng cách bên trong */
            border: none; /* Bỏ viền */
            border-radius: 5px; /* Bo góc */
            font-size: 15px; /* Kích thước chữ */
            cursor: pointer; /* Con trỏ chuột */
            transition: background-color 0.3s, transform 0.2s; /* Hiệu ứng chuyển màu và phóng to */
        }

        .buttonDB:hover {
            background-color: #00FF00; /* Màu nền khi hover */
            transform: scale(1.05); /* Phóng to nhẹ khi hover */
        }

        .buttonDB:active {
            transform: scale(0.95); /* Thu nhỏ khi nhấn */
        }
        .auto-item {
        display: flex;
        justify-content: space-between;
        margin: 8px 0;
        }

        .btn-on {
        background: #4CAF50;
        color: white;
        border: none;
        padding: 5px 14px;
        border-radius: 20px;
        }

        .btn-off {
        background: #aaa;
        color: white;
        border: none;
        padding: 5px 14px;
        border-radius: 20px;
        }

        .buttonTT {
            background-color: #4CAF50; /* Màu nền */
            color: white; /* Màu chữ */
            padding: 5px 15px; /* Khoảng cách bên trong */
            border: none; /* Bỏ viền */
            border-radius: 5px; /* Bo góc */
            font-size: 10px; /* Kích thước chữ */
            cursor: pointer; /* Con trỏ chuột */
            transition: background-color 0.3s, transform 0.2s; /* Hiệu ứng chuyển màu và phóng to */
        }

            .buttonTT:hover {
                background-color: #45a049; /* Màu nền khi hover */
                transform: scale(1.05); /* Phóng to nhẹ khi hover */
            }

            .buttonTT:active {
                transform: scale(0.95); /* Thu nhỏ khi nhấn */
            }
        .device-name {
            font-weight: bold; /* In đậm */
            margin-bottom: 5px; /* Khoảng cách dưới chữ "Bơm" */
        }
        .settings-container {
            display: flex;
            justify-content: space-between; /* Đẩy nút cài đặt sang bên phải */
            align-items: center;
            background-color: rgba(240, 240, 240, 0.8);
            padding: 10px 15px;
            border-radius: 10px;
            margin: 20px 0;
            gap: 10px;
        }
        .mode-left {
            display: flex;
            align-items: center;
            flex-wrap: wrap; /* Cho phép xuống dòng trên điện thoại nhỏ */
            gap: 15px;
        }

        .mode-status {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 16px;
        }

        #TTCD {
            color: #007bff;
            font-weight: bold;
        }

        /* Nút cài đặt cố định kích thước */
        .settings-button {
            flex-shrink: 0; /* Không cho phép nút này bị bóp nhỏ */
            background: none;
            border: none;
            cursor: pointer;
            padding: 5px;
        }

        .settings-icon {
            width: 35px;
            height: 35px;
        }
        .device-status {
            display: inline-block; /* Hiển thị dưới dạng khối nội tuyến */
            width: 100px; /* Cố định chiều rộng */
            text-align: center; /* Căn giữa chữ */
            white-space: nowrap; /* Ngăn không cho chữ nhảy dòng */
        }
        /* CSS cho phần Header mới */
        /* --- CSS HEADER CHUẨN --- */
        .header-top {
            display: grid;
            /* Chia 3 cột: Logo(100px) - Chữ(Tự động) - Logo(100px) */
            grid-template-columns: 100px 1fr 100px;
            align-items: center;
            padding: 15px;
            background: #fff;
            border-bottom: 3px solid #4CAF50;
            gap: 10px;
            border-radius: 8px 8px 0 0;
        }

        .school-logo {
            width: 100%;
            max-width: 90px;
            height: auto;
            justify-self: center;
        }

        .school-info {
            text-align: center;
        }

        .school-info h2 {
            margin: 2px 0;
            font-size: 16px;
            color: #008000;
            font-weight: bold;
        }

        .khoa-text {
            font-weight: bold;
            color: #333;
            margin: 5px 0;
            font-size: 14px;
        }
        .sub-info {
            grid-column: 1 / span 3; /* Ép dòng đề tài chiếm hết chiều ngang */
            text-align: center;
            border-top: 1px dashed #ccc;
            margin-top: 10px;
            padding-top: 8px;
        }
        .sub-info p {
            font-style: italic;
            font-size: 13px;
            margin: 2px 0;
            color: black;
            font-weight: bold;
        }
        @media (max-width: 768px) {
            .header-top {
                /* Giới hạn logo thu nhỏ tối thiểu là 50px */
                grid-template-columns: minmax(50px, 60px) 1fr minmax(50px, 60px);
                padding: 10px 5px;
                gap: 5px;
            }

            .school-logo {
                min-width: 50px; /* Không cho nhỏ hơn 50px */
            }

            .school-info h2 {
                font-size: 10px !important;
                line-height: 1.2;
            }

            .khoa-text {
                font-size: 9px !important;
            }

            .sub-info {
                display: block !important; /* Đảm bảo luôn hiện trên mobile */
            }

            .sub-info p {
                font-size: 9px !important;
                line-height: 1.4;
            }
            .settings-container {
                padding: 8px;
            }

            .mode-left {
                gap: 8px; /* Thu hẹp khoảng cách các nút */
            }

            .buttonCD, .buttonDB {
                padding: 8px 12px !important; /* Thu nhỏ nút */
                font-size: 12px !important;
                min-width: 80px; /* Giới hạn chiều rộng tối thiểu */
            }

            .mode-status {
                font-size: 13px;
            }

            .settings-icon {
                width: 28px;
                height: 28px;
            }
        }

        @media (max-width: 480px) {
            .header-top {
                 grid-template-columns: 50px 1fr 50px;
            }
            .school-info h2 { font-size: 8.5px !important; }
            .sub-info p { font-size: 8px !important; }
            .mode-left {
                justify-content: center;
            }
            .settings-container {
                flex-direction: column; /* Trên máy quá nhỏ thì nút cài đặt xuống dưới */
                gap: 10px;
            }
        }
        .btn-logout {
            background: #f44336;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }

        .btn-logout:hover {
            background: #d32f2f;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
        }

        .btn-logout:active {
            transform: translateY(0);
        }
        .exit{
            text-align: right;
        }
        /* --- CSS CHO ĐIỆN THOẠI (Responsive) --- */
        /* --- CSS CHO DI ĐỘNG --- */
        /* --- CSS Header dùng chung --- */
        .header-top {
            display: flex;
            flex-wrap: wrap; /* Cho phép các thành phần xuống dòng */
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            background-color: white;
            border-bottom: 2px solid #4CAF50;
            gap: 10px;
        }

        .school-logo {
            width: 80px; /* Kích thước máy tính */
            height: auto;
            flex-shrink: 0;
        }

        .school-info {
            flex: 1; /* Chiếm diện tích ở giữa */
            text-align: center;
        }

        #logList {
            list-style: none;
            padding: 0;
            max-height: 220px;
            overflow-y: auto;
        }

        #logList li {
            padding: 6px 8px;
            border-bottom: 1px dashed #ccc;
            font-size: 14px;
        }

        #logList li:nth-child(odd) {
            background: #f9f9f9;
        }
        @keyframes popup {
            from {
                transform: scale(0.8);
                opacity: 0;
            }
            to {
                transform: scale(1);
                opacity: 1;
            }
        }
    </style>
</head>
<body>

    <div class="container">
        <div class="header-top">
            <img src="anh/logotruong.png" alt="Logo Trường" class="school-logo">

            <div class="school-info">
                <div class="main-title">
                    <h2>ĐẠI HỌC ĐÀ NẴNG</h2>
                    <h2>TRƯỜNG ĐẠI HỌC SƯ PHẠM KỸ THUẬT</h2>
                    <p class="khoa-text">KHOA ĐIỆN - ĐIỆN TỬ</p>
                </div>
                
                <div class="sub-info">
                    <p>Đề tài: Hệ thống giám sát và điều khiển nhà kính thông minh sử dụng Lora và xử lý ảnh tại chỗ</p>
                    <p>GVHD: T.S Trần Hoàng Vũ</p>
                    <p>SVTH: Châu Anh Kiệt- Lê Duy Minh</p>
                </div>
            </div>

            <img src="anh/logokhoa.png" alt="Logo Khoa" class="school-logo">
        </div>

        <h1>Quản Lý Thiết Bị Thông Minh</h1>
        <div class="exit">
            <button onclick="logout()" class="btn-logout">
                Đăng xuất
            </button>
        </div>
        <div class="settings-container">
            <div class="mode-left">
                <div class="mode-status">
                    <strong>Chế độ:</strong>
                    <span id="TTCD">Auto</span>
                </div>
                <button class="buttonCD" id="NBCD">Chuyển Chế Độ</button>
                <button class="buttonDB" onclick="goBack()">Dự Báo Thời Tiết</button>
            </div>
            <div class="mode-status">
                <strong>Hệ thống:</strong>
                <span id="SystemStatus">---</span>
            </div>
            <button class="buttonDB" onclick="resetLock()">RESET LOCK</button>
            <button class="settings-button" onclick="openPopup()">
                <img src="https://img.icons8.com/material-rounded/50/000000/settings.png" class="settings-icon" alt="Cài đặt">
            </button>
        </div>

        <div class="section">
            <h2>Thông Số Môi Trường</h2>
            <div class="info-container">
                <div class="info-item">
                    <img src="https://img.icons8.com/?size=100&id=Ip0sudtehGiR&format=png&color=000000" class="info-icon" >
                    <div>
                        <div>Điện Áp</div>
                        <div class="info-value" id="GTDienAp">220 V</div>
                    </div>
                </div>
                                <div class="info-item">
                    <img src="https://img.icons8.com/?size=100&id=39434&format=png&color=000000" class="info-icon" >
                    <div>
                        <div>Công Suất</div>
                        <div class="info-value" id="GTCongSuat">1 kW</div>
                    </div>
                </div>
                <div class="info-item">
                    <img src="https://img.icons8.com/color/100/electricity.png" class="info-icon" >
                    <div>
                        <div>Dòng Điện</div>
                        <div class="info-value" id="DongDien">0 A</div>
                    </div>
                </div>
                <div class="info-item">
                    <img src="https://img.icons8.com/color/50/000000/temperature.png" class="info-icon" alt="Nhiệt độ">
                    <div>
                        <div>Nhiệt độ</div>
                        <div class="info-value" id="ND">20 độ C</div>
                    </div>
                </div>

                <div class="info-item">
                    <img src="https://img.icons8.com/color/50/000000/humidity.png" class="info-icon" alt="Độ ẩm không khí">
                    <div>
                        <div>Độ ẩm không khí</div>
                        <div class="info-value" id="DA">60%</div>
                    </div>
                </div>

                <div class="info-item">
                        <img id="logocbas" src="https://img.icons8.com/color/50/000000/moon.png" class="info-icon" alt="Buổi tối">
                        <div>
                            <div id="textcbas">Buổi Tối</div>
                        </div>
                </div>

                <div class="info-item" >
                    <img id="logocbm" src="https://img.icons8.com/color/50/000000/rain.png" class="info-icon" alt="Trời mưa">
                    <div>
                        <div id="textcbm">Trời Mưa</div>
                    </div>
                </div>

                <div class="info-item">
                    <img src="https://img.icons8.com/color/50/000000/water.png" class="info-icon" alt="Mực nước">
                    <div>
                        <div>Mực Nước</div>
                        <div  id="textcbmn" class="info-value">Cao</div>
                    </div>
                </div>

                <div class="info-item">
                    <img src="https://img.icons8.com/color/50/000000/soil.png" class="info-icon" alt="Đất">
                    <div>
                        <div>Độ ẩm đất</div>
                        <div  id="textcbdad" class="info-value">Cao</div>
                    </div>
                </div>
            </div>
        </div>
        <div class="section">
            <h2>Quản Lý Thiết Bị</h2>
            <div class="device-container">
                <div class="device-item">
                    <img src="https://img.icons8.com/?size=100&id=ehDsuflHffkO&format=png&color=000000" class="device-icon" alt="Bơm"> <!-- Biểu tượng bơm -->
                    <div>
                        <div class="device-name">Bơm</div>
                        <div class="device-status" id="TTBom">Đang sử dụng</div>
                        <button class="buttonTT" id="TTBomm">Tắt Thiết Bị</button>
                    </div>
                </div>

                <div class="device-item">
                    <img src="https://img.icons8.com/color/50/000000/fan.png" class="device-icon" alt="Quạt">
                    <div>
                        <div class="device-name">Quạt</div>
                        <div class="device-status" id="TTQuat">Đang sử dụng</div>
                        <button class="buttonTT" id="TTQuatt">Tắt Thiết Bị</button>
                    </div>
                </div>

                <div class="device-item">
                    <img src="https://img.icons8.com/color/50/000000/light-on.png" class="device-icon" alt="Đèn">
                    <div>
                        <div class="device-name">Đèn</div>
                        <div class="device-status" id="TTDen">Đang sử dụng</div>
                        <button class="buttonTT" id="TTDenn">Tắt Thiết Bị</button>
                    </div>
                </div>

                <div class="device-item">
                    <img src="https://img.icons8.com/color/50/000000/bell.png" class="device-icon" alt="Chuông">
                    <div>
                        <div class="device-name">Chuông</div>
                        <div class="device-status" id="TTChuong">Đang sử dụng</div>
                        <button class="buttonTT" id="TTChuongg">Tắt Thiết Bị</button>
                    </div>
                </div>

                <div class="device-item">
                    <img src="anh/rem.png" class="device-icon" alt="Rèm">
                    <div>
                        <div class="device-name">Rèm</div>
                        <div class="device-status" id="TTRem">Đang mở</div>
                        <button class="buttonTT" id="TTRemm">Đang đóng</button>
                    </div>
                </div>
            </div>
        </div>
        <div class="section">
            <h2>Lịch sử sự kiện</h2>
            <select id="filterDevice">
                <option value="ALL">-- Tất cả thiết bị --</option>
                <option value="QUAT">Quạt</option>
                <option value="DEN">Đèn</option>
                <option value="BOM">Bơm</option>
                <option value="REM">Rèm</option>
                <option value="CHUONG">Chuông</option>
            </select>
            <select id="filterMode">
                <option value="ALL">-- Tất cả chế độ --</option>
                <option value="AUTO">AUTO</option>
                <option value="MANUAL">MANUAL</option>
            </select>
            <ul id="logList"></ul>
        </div>    
    </div>

    <div class="popup" id="settingsPopup">
        <div class="popup-content">
            <h2>Thông Số Cài Đặt</h2>
            <div class="input-field">
                <label>Ngưỡng quá dòng (A):</label>
                <input type="number" step="0.01" id="overCurrent" />
            </div>

            <div class="input-field">
                <label>Nhiệt độ(°C):</label>
                <input type="number" id="temperature" />
            </div>
            <div class="input-field">
                <label>Độ ẩm (%):</label>
                <input type="number" id="humidity" />
            </div>
            <div class="auto-item">
            <span>Bơm theo độ ẩm đất</span>
            <button id="bomAuto" class="btn-off" onclick="toggleAuto('bom')">OFF</button>
            </div>

            <div class="auto-item">
            <span>Quạt theo nhiệt độ</span>
            <button id="quatAuto" class="btn-off" onclick="toggleAuto('quat')">OFF</button>
            </div>

            <div class="auto-item">
            <span>Đèn khi trời tối</span>
            <button id="denAuto" class="btn-off" onclick="toggleAuto('den')">OFF</button>
            </div>

            <div class="auto-item">
            <span>Rèm khi mưa / tối</span>
            <button id="remAuto" class="btn-off" onclick="toggleAuto('rem')">OFF</button>
            </div>

            <div class="auto-item">
            <span>Chuông khi nước đầy</span>
            <button id="chuongAuto" class="btn-off" onclick="toggleAuto('chuong')">OFF</button>
            </div>

            <button class="confirmSettings" onclick="confirmSettings()">Xác Nhận</button>
            <button class="close-button" onclick="closePopup()">Đóng</button>

        </div>
    </div>

    <script>
        function openPopup() {
            document.getElementById('settingsPopup').style.display = 'flex';
            loadCurrentSettings();
            loadAutoSettings();
        }

        function closePopup() {
            document.getElementById('settingsPopup').style.display = 'none';
        }

        function loadCurrentSettings() {
            firebase.database().ref('GiaTriDat/ND').once('value').then(snap => {
                document.getElementById('temperature').value = snap.val() || '';
            });

            firebase.database().ref('GiaTriDat/DA').once('value').then(snap => {
                document.getElementById('humidity').value = snap.val() || '';
            });

            firebase.database().ref('CaiDat/NguongDong').once('value').then(snap => {
                document.getElementById('overCurrent').value = snap.val() || '';
            });
        }

        function confirmSettings() {
            const temperature = Number(document.getElementById('temperature').value);
            const humidity = Number(document.getElementById('humidity').value);
            const overCurrent = Number(document.getElementById('overCurrent').value);
            firebase.database().ref('GiaTriDat').update({
                ND: temperature,
                DA: humidity
            });

            firebase.database().ref('CaiDat/NguongDong').set(overCurrent);


            closePopup();
        }

    </script>

    <script src="https://www.gstatic.com/firebasejs/8.0.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.0.0/firebase-database.js"></script>
    <script>
        // Cấu hình Firebase của bạn
        const firebaseConfig = {
            apiKey: "AIzaSyAVb7CKc2LS9okIpT6sfEjyytaM2Pa5CRs",
            authDomain: "loraras.firebaseapp.com",
            projectId: "loraras",
            storageBucket: "loraras.appspot.com",
            messagingSenderId: "38848964775",
            appId: "1:38848964775:web:2215d9c343dd57784c9382",
            measurementId: "G-FTR3DHBGK6"
        };
        // Khởi tạo Firebase
        firebase.initializeApp(firebaseConfig);
    </script>

    <script>
        // Kiểm tra xem đã đăng nhập chưa
        if (sessionStorage.getItem("isLoggedIn") !== "true") {
            // Nếu chưa, bắt quay lại trang login ngay lập tức
            window.location.href = "login.html";
        }

        // Hàm đăng xuất
        function logout() {
            sessionStorage.removeItem("isLoggedIn");
            window.location.href = "login.html";
        }
        function listenRemState() {
        firebase.database().ref('ThietBi/REM').on('value', function (snapshot) {
            const val = snapshot.val();
            const status = document.getElementById('TTRem');
            const btn = document.getElementById('TTRemm');

            if (val === 1) {
                status.textContent = 'Đang mở';
                status.style.color = '#FF5733'; // đỏ
                btn.textContent = 'Đóng Rèm';
                btn.style.backgroundColor = '#4CAF50';
            } else {
                status.textContent = 'Đang đóng';
                status.style.color = '#4CAF50'; // xanh
                btn.textContent = 'Mở Rèm';
                btn.style.backgroundColor = '#FF5733';
            }
        });
        }
        // Hàm lắng nghe sự thay đổi trạng thái thiết bị
        function listenDeviceState(deviceRefName, buttonId, statusId) {
            firebase.database().ref(deviceRefName).on('value', function (snapshot) {
                var currentValue = snapshot.val();
                var button = document.getElementById(buttonId);
                var statusElement = document.getElementById(statusId);

                if (currentValue === 1) {
                    button.style.backgroundColor = '#FF5733'; // Màu đỏ
                    button.style.color = '#FFFFFF'; // Màu chữ trắng
                    button.textContent = 'Tắt Thiết Bị';
                    statusElement.textContent = ' Đang sử dụng';
                    statusElement.style.color = '#4CAF50'; // Màu xanh cho "Đang sử dụng"
                } else {
                    button.style.backgroundColor = '#4CAF50'; // Màu xanh lá
                    button.style.color = '#FFFFFF'; // Màu chữ trắng
                    button.textContent = 'Bật Thiết Bị';
                    statusElement.textContent = 'Không sử dụng';
                    statusElement.style.color = '#FF5733'; // Màu đỏ cho "Không sử dụng"
                }
            });
        }
        document.addEventListener("DOMContentLoaded", function () {
            var DienApRef = firebase.database().ref('CamBien/DienAp');

            DienApRef.on('value', function (snapshot) {
                var DienApValue = snapshot.val();
                var DienApElement = document.getElementById('GTDienAp');

                // Cập nhật giá trị nhiệt độ trong div
                DienApElement.textContent = DienApValue + ' V';
            });
        });
        document.addEventListener("DOMContentLoaded", function () {
            var CongSuatRef = firebase.database().ref('CamBien/CongSuat');

            CongSuatRef.on('value', function (snapshot) {
                var CongSuatValue = snapshot.val();
                var CongSuatElement = document.getElementById('GTCongSuat');

                // Cập nhật giá trị nhiệt độ trong div
                CongSuatElement.textContent = CongSuatValue + ' kW';
            });
        });
        document.addEventListener("DOMContentLoaded", function () {
            var DongDienRef = firebase.database().ref('CamBien/DongDien');

            DongDienRef.on('value', function (snapshot) {
            document.getElementById('DongDien').textContent = snapshot.val() + ' A';
        });
        });
        document.addEventListener("DOMContentLoaded", function () {
            var temperatureRef = firebase.database().ref('CamBien/ND');

            temperatureRef.on('value', function (snapshot) {
                var temperatureValue = snapshot.val();
                var temperatureElement = document.getElementById('ND');

                // Cập nhật giá trị nhiệt độ trong div
                temperatureElement.textContent = temperatureValue + ' độ C';
            });
        });
        document.addEventListener("DOMContentLoaded", function () {
            var temperatureRef = firebase.database().ref('CamBien/DA');

            temperatureRef.on('value', function (snapshot) {
                var temperatureValue = snapshot.val();
                var temperatureElement = document.getElementById('DA');

                // Cập nhật giá trị nhiệt độ trong div
                temperatureElement.textContent = temperatureValue + ' %';
            });
        });
        document.addEventListener("DOMContentLoaded", function () {
            var cbASRef = firebase.database().ref('CamBien/CBAS');

            cbASRef.on('value', function (snapshot) {
                var cbASValue = snapshot.val();
                var logoCBAS = document.getElementById('logocbas');
                var textCBAS = document.getElementById('textcbas');

                if (cbASValue === 0) {
                    logoCBAS.src = "https://img.icons8.com/color/50/000000/sun.png"; // Logo Buổi sáng
                    textCBAS.textContent = "Buổi Sáng";
                } else if (cbASValue === 1) {
                    logoCBAS.src = "https://img.icons8.com/color/50/000000/moon.png"; // Logo Buổi tối
                    textCBAS.textContent = "Buổi Tối";
                }
            });
        });
        var cbMRef = firebase.database().ref('CamBien/CBM');
        cbMRef.on('value', function (snapshot) {
            var cbMValue = snapshot.val();
            var logoCBM = document.getElementById('logocbm');
            var textCBM = document.getElementById('textcbm');

            if (cbMValue === 0) {
                logoCBM.src = "https://img.icons8.com/color/50/000000/rain.png"; // Logo Trời mưa
                textCBM.textContent = "Trời Mưa";
            } else if (cbMValue === 1) {
                logoCBM.src = "https://img.icons8.com/?size=100&id=19543&format=png&color=000000"; // Logo Trời trong
                textCBM.textContent = "Trời Trong";
            }
        });
        var cbmnRef = firebase.database().ref('CamBien/CBMN');
        cbmnRef.on('value', function (snapshot) {
            var cbmnValue = snapshot.val();
            var textCBMN = document.getElementById('textcbmn');

            if (cbmnValue === 0) {
                textCBMN.textContent = "Thấp";
            } else if (cbmnValue === 1) {
                textCBMN.textContent = "Cao";
            }
        });

        var cbdadRef = firebase.database().ref('CamBien/CBDAD');
        cbdadRef.on('value', function (snapshot) {
            var cbdadValue = snapshot.val();
            var textCBDAD = document.getElementById('textcbdad');

            if (cbdadValue === 0) {
                textCBDAD.textContent = "Cao";
            } else if (cbdadValue === 1) {
                textCBDAD.textContent = "Thấp";
            }
        });

        var ttcdRef = firebase.database().ref('CheDo/TT');
        ttcdRef.on('value', function (snapshot) {
            var ttcdValue = snapshot.val();
            var textTTCD = document.getElementById('TTCD');

            if (ttcdValue === "0") {
                textTTCD.textContent = "Manual";
            } else if (ttcdValue === "1") {
                textTTCD.textContent = "Auto";
            }
        });

        document.getElementById('NBCD').addEventListener('click', function () {
            var chedoRef = firebase.database().ref('CheDo/TT');

            chedoRef.once('value', function (snapshot) {
                var currentValue = snapshot.val();
                var newValue = (currentValue === "1") ? "0" : "1"; // Chuyển đổi giữa 0 và 1
                chedoRef.set(newValue); // Gửi giá trị mới về Firebase
            });
        });

        const autoPath = {
        bom: 'AutoBomTheoDat',
        quat: 'AutoQuatTheoND',
        den: 'AutoDenTheoAS',
        rem: 'AutoRemTheoMuaToi',
        chuong: 'ChuongKhiNuocDay'
        };

        function toggleAuto(type) {
        const btn = document.getElementById(type + 'Auto');
        const isOn = btn.classList.contains('btn-on');

        btn.classList.toggle('btn-on', !isOn);
        btn.classList.toggle('btn-off', isOn);
        btn.innerText = isOn ? 'OFF' : 'ON';

        firebase.database().ref('CaiDat/' + autoPath[type])
            .set(isOn ? 0 : 1);
        }
        function loadAutoSettings() {
        firebase.database().ref('CaiDat').once('value', snap => {
            const c = snap.val() || {};
            setBtn('bom', c.AutoBomTheoDat);
            setBtn('quat', c.AutoQuatTheoND);
            setBtn('den', c.AutoDenTheoAS);
            setBtn('rem', c.AutoRemTheoMuaToi);
            setBtn('chuong', c.ChuongKhiNuocDay);
        });
        }

        function setBtn(type, value) {
        const btn = document.getElementById(type + 'Auto');
        if (value == 1) {
            btn.className = 'btn-on';
            btn.innerText = 'ON';
        } else {
            btn.className = 'btn-off';
            btn.innerText = 'OFF';
        }
        }

        // Gán sự kiện click cho từng nút
        function isManualMode(callback) {
            var chedoRef = firebase.database().ref('CheDo/TT');
            chedoRef.once('value', function (snapshot) {
                var chedoValue = snapshot.val();
                callback(chedoValue === "0"); // Chỉ cho phép khi chế độ là 0
            });
        }

        // Thêm sự kiện click cho các nút
        document.getElementById('TTBomm').addEventListener('click', function () {
            isManualMode(function (isAllowed) {
                if (isAllowed) toggleDevice('ThietBi/BOM');
            });
        });

        document.getElementById('TTQuatt').addEventListener('click', function () {
            isManualMode(function (isAllowed) {
                if (isAllowed) toggleDevice('ThietBi/QUAT');
            });
        });

        document.getElementById('TTDenn').addEventListener('click', function () {
            isManualMode(function (isAllowed) {
                if (isAllowed) toggleDevice('ThietBi/DEN');
            });
        });

        document.getElementById('TTChuongg').addEventListener('click', function () {
            isManualMode(function (isAllowed) {
                if (isAllowed) toggleDevice('ThietBi/CHUONG');
            });
        });

        document.getElementById('TTRemm').addEventListener('click', function () {
            isManualMode(function (isAllowed) {
                if (isAllowed) toggleDevice('ThietBi/REM');
            });
        });
        function writeLog(device, action, detail) {
            const now = new Date();
            firebase.database().ref("LogSuKien").push({
                time: now.toISOString().slice(0,19).replace("T"," "),
                timestamp: Math.floor(now.getTime()/1000),
                device: device,
                action: action,
                detail: detail,
                mode: "MANUAL",
                source: "WEB"
            });
        }
        
        // Hàm chuyển đổi trạng thái thiết bị
        function toggleDevice(deviceRefName) {
            const ref = firebase.database().ref(deviceRefName);

            ref.once('value', snap => {
                const val = snap.val();
                const newVal = val === 1 ? 0 : 1;
                ref.set(newVal);

                const device = deviceRefName.split("/")[1];
                writeLog(device, newVal ? "BẬT" : "TẮT", "Điều khiển thủ công");
            });
        }

        // Lắng nghe trạng thái cho từng thiết bị
        listenDeviceState('ThietBi/BOM', 'TTBomm', 'TTBom');
        listenDeviceState('ThietBi/QUAT', 'TTQuatt', 'TTQuat');
        listenDeviceState('ThietBi/DEN', 'TTDenn', 'TTDen');
        listenDeviceState('ThietBi/CHUONG', 'TTChuongg', 'TTChuong');
        listenRemState('ThietBi/REM', 'TTRemm', 'TTRem');

        // Hàm quay lại trang chính (Main.html)
        function goBack() {
        window.location.href = "dashboard.html"; // Điều hướng tới trang Main.html
        }
        firebase.database().ref('HeThong/TrangThai').on('value', snap => {
            const st = snap.val();
            const el = document.getElementById('SystemStatus');

            if (st === "AUTO_OK") {
                el.textContent = "Auto hoạt động";
                el.style.color = "green";
            } else if (st === "MANUAL") {
                el.textContent = "Manual";
                el.style.color = "orange";
            }else if (st === "LOCK") {
                el.textContent = "Lock";
                el.style.color = "orange";
            } else {
                el.textContent = "Lỗi / Mất kết nối";
                el.style.color = "red";
            }
        });
    </script>
    <script>
        // ================== BIẾN GLOBAL ==================
        let allLogs = [];
        const logList = document.getElementById("logList");

        // ================== GHI LOG ==================
        function writeLog(device, action, detail, mode = "MANUAL") {
            const now = new Date().toLocaleString("sv-SE"); // yyyy-mm-dd HH:mm:ss

            firebase.database().ref("LogSuKien").push({
                time: now,
                device: device,
                action: action,
                detail: detail,
                mode: mode
            });
        }

        // ================== ĐỌC LOG 1 LẦN – CACHE ==================
        firebase.database().ref("LogSuKien").on("value", snapshot => {
            allLogs = [];
            snapshot.forEach(child => {
                allLogs.push(child.val());
            });

            // Sắp xếp mới → cũ
            allLogs.sort((a, b) => b.time.localeCompare(a.time));

            renderLogs();
        });

        // ================== RENDER + FILTER ==================
        function renderLogs() {
            logList.innerHTML = "";

            const deviceFilter = document.getElementById("filterDevice").value;
            const modeFilter = document.getElementById("filterMode").value;

            allLogs.forEach(log => {
                if (filterLog(log, deviceFilter, modeFilter)) {
                    logList.innerHTML += `
                        <li>
                            [${log.time}] 
                            <b>${log.device}</b> - ${log.action}: 
                            ${log.detail} 
                            (<span style="color:${log.mode === "AUTO" ? "blue" : "green"}">
                                ${log.mode}
                            </span>)
                        </li>
                    `;
                }
            });
        }

        // ================== LOGIC LỌC (CỐT LÕI) ==================
        function filterLog(log, device, mode) {
            if (device === "ALL" && mode === "ALL") return true;
            if (device === "ALL") return log.mode === mode;
            if (mode === "ALL") return log.device === device;
            return log.device === device && log.mode === mode;
        }

        // ================== SỰ KIỆN DROPDOWN ==================
        document.getElementById("filterDevice").addEventListener("change", renderLogs);
        document.getElementById("filterMode").addEventListener("change", renderLogs);
    </script>
    <div id="overCurrentAlert" style="
    display:none;
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.4);
    z-index: 9999;
    justify-content: center;
    align-items: center;">
        <div style="
            background: #ff4d4d;
            color: white;
            padding: 25px 30px;
            border-radius: 12px;
            box-shadow: 0 6px 15px rgba(0,0,0,0.4);
            text-align: center;
            min-width: 300px;
            animation: popup 0.3s ease;
        ">
            ⚠️ <b style="font-size:18px">CẢNH BÁO QUÁ DÒNG!</b><br><br>
            Vui lòng kiểm tra hệ thống
            <br><br>
            <button onclick="acknowledgeOverCurrent()" style="
                background:#fff;
                color:#ff4d4d;
                border:none;
                padding:8px 16px;
                border-radius:6px;
                cursor:pointer;
                font-weight:bold;
                font-size:14px;
            ">
                Tôi đã kiểm tra
            </button>
        </div>
    </div>
    <script>
        function forceAutoToManual() {
            const cheDoRef = firebase.database().ref('CheDo/TT');

            cheDoRef.once('value', snap => {
                if (snap.val() === "1") { // Đang AUTO
                    cheDoRef.set("0");   // Ép về MANUAL

                    firebase.database().ref('HeThong/TrangThai')
                        .set("LOCK_OVER_CURRENT");

                    writeLog(
                        "HETHONG",
                        "CHUYỂN CHẾ ĐỘ",
                        "Quá dòng – hệ thống chuyển từ AUTO sang MANUAL",
                        "AUTO"
                    );
                }
            });
        }
    </script>

    <script>
    let isOverCurrent = false;
    let isAcknowledged = false;

    // Lắng nghe dòng điện
    firebase.database().ref('CamBien/DongDien').on('value', snap => {
        const dongDien = Number(snap.val());

        firebase.database().ref('CaiDat/NguongDong').once('value', nguongSnap => {
            const nguong = Number(nguongSnap.val());

            if (dongDien > nguong) {
                forceAutoToManual();

                firebase.database().ref('CanhBao/QuaDong').set(1);

                firebase.database().ref('CanhBao/AckQuaDong').once('value', ackSnap => {
                    const isAck = ackSnap.val() === 1;

                    if (!isAck) {
                        showOverCurrentAlert();

                        if (!window.loggedOverCurrent) {
                            writeLog(
                                "HETHONG",
                                "QUÁ DÒNG",
                                `Dòng điện ${dongDien}A vượt ngưỡng ${nguong}A`,
                                "AUTO"
                            );
                            window.loggedOverCurrent = true;
                        }
                    }
                });
            }

            // ❗ DÒNG ĐIỆN ĐÃ VỀ BÌNH THƯỜNG
            // → KHÔNG ĐƯỢC TỰ TẮT CẢNH BÁO
            // → CHỜ NGƯỜI DÙNG XÁC NHẬN
        });
    });
    function showOverCurrentAlert() {
        document.getElementById("overCurrentAlert").style.display = "flex";
    }

    function hideOverCurrentAlert() {
        document.getElementById("overCurrentAlert").style.display = "none";
    }
    function acknowledgeOverCurrent() {
        firebase.database().ref('CanhBao/AckQuaDong').set(1);
        hideOverCurrentAlert();

        writeLog(
            "HETHONG",
            "XÁC NHẬN",
            "Người dùng đã kiểm tra sự cố quá dòng",
            "MANUAL"
        );
    }
    </script>
    <script>
    document.addEventListener("DOMContentLoaded", () => {
        firebase.database().ref('CanhBao/AckQuaDong').once('value', snap => {
            if (snap.val() === 1) {
                hideOverCurrentAlert();
            }
        });
    });
    </script>
    <script>
    function resetLock() {
        if (!confirm("Xác nhận thoát LOCK và đưa hệ thống về MANUAL?")) return;

        firebase.database().ref().update({
            "CanhBao/QuaDong": 0,
            "CheDo/TT": "0"
        });

        alert("Đã RESET LOCK. Hệ thống về MANUAL.");
    }
    let isLocked = false;

    firebase.database().ref('HeThong/TrangThai').on('value', snap => {
        isLocked = (snap.val() === "LOCK");
        setButtonsDisabled(isLocked);
    });

    function setButtonsDisabled(disabled) {
        document.querySelectorAll('.buttonTT, .buttonCD').forEach(btn => {
            btn.disabled = disabled;
            btn.style.opacity = disabled ? 0.5 : 1;
        });
    }
    firebase.database().ref('HeThong/TrangThai').on('value', snap => {
        if (snap.val() === "LOCK") {
            document.getElementById("overCurrentAlert").style.display = "flex";
        } else {
            document.getElementById("overCurrentAlert").style.display = "none";
        }
    });

    </script>

</body>
</html >
